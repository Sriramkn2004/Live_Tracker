<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Dashboard - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0 !important;
        }
        .table {
            margin-bottom: 0;
        }
        .badge {
            font-size: 0.8em;
        }
        .location-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .ip-badge {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }
        .real-time-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .stats-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
        }
        .map-container {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-line me-2"></i>Live Tracking Dashboard</h2>
                        <p class="mb-0">Real-time location and IP tracking data</p>
                        <span class="badge bg-success real-time-indicator">
                            <i class="fas fa-circle me-1"></i>Live
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalClicks">0</div>
                    <div>Total Clicks</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="uniqueIPs">0</div>
                    <div>Unique IPs</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="locationsFound">0</div>
                    <div>Locations Found</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="activeLinks">0</div>
                    <div>Active Links</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Tracking Data Table -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-table me-2"></i>Recent Tracking Data</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Time</th>
                                        <th>IP Address</th>
                                        <th>Location</th>
                                        <th>Browser</th>
                                        <th>OS</th>
                                        <th>City/Country</th>
                                    </tr>
                                </thead>
                                <tbody id="trackingTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Generated Links -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-link me-2"></i>Generated Links</h5>
                    </div>
                    <div class="card-body">
                        <div id="linksList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading links...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marker-alt me-2"></i>Location Map</h5>
                    </div>
                    <div class="card-body">
                        <div id="map" style="height: 400px; width: 100%; border-radius: 10px;"></div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Map shows all tracked locations. Click markers for details.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Using OpenStreetMap with Leaflet (free, no API key required) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Socket.io connection for real-time updates
        const socket = io();
        
        // Leaflet Maps (OpenStreetMap - free, no API key required)
        let map;
        let markers = [];
        
        function initMap() {
            try {
                // Initialize Leaflet map centered on India
                map = L.map('map').setView([20.5937, 78.9629], 6); // India center
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
                
                console.log('Leaflet map initialized successfully');
                
                // Add existing markers
                updateMapMarkers();
            } catch (error) {
                console.error('Error initializing map:', error);
                // Show fallback message
                document.getElementById("map").innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
                        <i class="fas fa-map fa-3x mb-3"></i>
                        <div>Map failed to load</div>
                        <small>Map functionality unavailable</small>
                    </div>
                `;
            }
        }
        
        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initMap, 1000); // Wait 1 second for DOM to be ready
        });
        
        function updateMapMarkers() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.log('Leaflet not loaded yet, skipping map update');
                return;
            }
            
            // Check if map is initialized
            if (!map) {
                console.log('Map not initialized yet, skipping map update');
                return;
            }
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add markers for each tracking data with location
            trackingData.forEach((data, index) => {
                if (data.location && data.location.latitude && data.location.longitude) {
                    const marker = L.marker([data.location.latitude, data.location.longitude])
                        .addTo(map)
                        .bindPopup(`
                            <div style="padding: 10px;">
                                <h6><i class="fas fa-map-marker-alt"></i> Location ${index + 1}</h6>
                                <p><strong>Coordinates:</strong> ${data.location.latitude.toFixed(4)}, ${data.location.longitude.toFixed(4)}</p>
                                <p><strong>IP:</strong> ${data.ip || 'Unknown'}</p>
                                <p><strong>Browser:</strong> ${data.browser || 'Unknown'}</p>
                                <p><strong>OS:</strong> ${data.os || 'Unknown'}</p>
                                <p><strong>Time:</strong> ${formatTimestamp(data.timestamp)}</p>
                                <p><strong>Accuracy:</strong> ${data.location.accuracy ? data.location.accuracy.toFixed(0) + 'm' : 'Unknown'}</p>
                            </div>
                        `);
                    
                    markers.push(marker);
                }
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Global variables
        let trackingData = [];
        let links = [];
        let uniqueIPs = new Set();
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }
        
        // Format location
        function formatLocation(location) {
            if (location && location.latitude && location.longitude) {
                return `${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}`;
            }
            return 'Not available';
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('totalClicks').textContent = trackingData.length;
            document.getElementById('uniqueIPs').textContent = uniqueIPs.size;
            document.getElementById('locationsFound').textContent = 
                trackingData.filter(data => data.location && data.location.latitude).length;
            document.getElementById('activeLinks').textContent = links.length;
        }
        
        // Update tracking table
        function updateTrackingTable() {
            const tbody = document.getElementById('trackingTableBody');
            
            if (trackingData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>No tracking data yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = trackingData.slice(0, 20).map(data => `
                <tr>
                    <td>
                        <small>${formatTimestamp(data.timestamp)}</small>
                    </td>
                    <td>
                        <span class="badge ip-badge">${data.ip || 'Unknown'}</span>
                    </td>
                    <td>
                        ${data.location && data.location.latitude ? 
                            `<span class="badge location-badge">${formatLocation(data.location)}</span>` : 
                            '<span class="badge bg-secondary">No location</span>'
                        }
                    </td>
                    <td>
                        <small>${data.browser || 'Unknown'}</small>
                    </td>
                    <td>
                        <small>${data.os || 'Unknown'}</small>
                    </td>
                    <td>
                        <small>${data.city || 'Unknown'}, ${data.country || 'Unknown'}</small>
                    </td>
                </tr>
            `).join('');
            
            // Update map markers
            if (typeof updateMapMarkers === 'function') {
                updateMapMarkers();
            }
        }
        
        // Update links list
        function updateLinksList() {
            const linksList = document.getElementById('linksList');
            
            if (links.length === 0) {
                linksList.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>No links generated yet
                    </div>
                `;
                return;
            }
            
            linksList.innerHTML = links.map(link => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <h6 class="card-title">
                            <small class="text-muted">Link ID: ${link.linkId.substring(0, 8)}...</small>
                        </h6>
                        <p class="card-text">
                            <small>
                                <strong>Original:</strong> ${link.originalUrl}<br>
                                <strong>Clicks:</strong> ${link.clicks}
                            </small>
                        </p>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyLink('${link.fakeUrl}')">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Copy link to clipboard
        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                // Show feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }
        
        // Load initial data
        async function loadInitialData() {
            try {
                console.log('Loading initial data...');
                
                // Load tracking data
                const trackingResponse = await fetch('/api/tracking-data');
                console.log('Tracking response status:', trackingResponse.status);
                
                if (!trackingResponse.ok) {
                    throw new Error(`HTTP error! status: ${trackingResponse.status}`);
                }
                
                trackingData = await trackingResponse.json();
                console.log('Loaded tracking data:', trackingData);
                
                // Load links
                const linksResponse = await fetch('/api/links');
                console.log('Links response status:', linksResponse.status);
                
                if (!linksResponse.ok) {
                    throw new Error(`HTTP error! status: ${linksResponse.status}`);
                }
                
                links = await linksResponse.json();
                console.log('Loaded links:', links);
                
                // Update unique IPs
                trackingData.forEach(data => {
                    if (data.ip) uniqueIPs.add(data.ip);
                });
                
                // Update UI
                updateStats();
                updateTrackingTable();
                updateLinksList();
                
                console.log('Initial data loaded successfully');
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                
                // Show error message in the table
                const tbody = document.getElementById('trackingTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error loading data: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // Socket.io event listeners
        socket.on('newTrackingData', (data) => {
            console.log('New tracking data received:', data);
            
            // Add to tracking data
            trackingData.unshift(data);
            
            // Add to unique IPs
            if (data.ip) uniqueIPs.add(data.ip);
            
            // Update UI
            updateStats();
            updateTrackingTable();
            
            // Update map if new location data
            if (data.location && data.location.latitude && typeof updateMapMarkers === 'function') {
                updateMapMarkers();
            }
        });
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadInitialData);
        
        // Auto-refresh every 30 seconds
        setInterval(loadInitialData, 30000);
    </script>
</body>
</html>
